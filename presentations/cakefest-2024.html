<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Passbolt CakeFest 2024</title>

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/night.css" id="theme">

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
        section {
            font-family: 'Roboto', sans-serif;
            /*font-family: "Open Sans",Verdana,sans-serif!important;*/
        }
        .white-shadowed {
            color: white!important;
            text-shadow: 0 0 10px #000000!important;
        }
        .cakephp {
            color: #D33C44!important;
        }
        p.small {
            font-size: large;
        }
        .shadow {
            -webkit-box-shadow: 4px 6px 5px -4px rgba(0,0,0,0.75);
            -moz-box-shadow: 4px 6px 5px -4px rgba(0,0,0,0.75);
            box-shadow: 4px 6px 5px -4px rgba(0,0,0,0.75);
        }
        .slides {
            width: 1120px!important;
        }
        i {
            font-style: italic;
        }
        div.luxembourg {
            background: rgb(238,36,54);
            background: linear-gradient(0deg, rgba(238,36,54,1) 0%, rgba(255,255,255,1) 33%, rgba(255,255,255,1) 66%, rgba(0,156,215,1) 100%);
            padding: 50px;
            /*border: 3px solid lightgrey;*/
            /*border-radius: 15px;*/
        }
        td {
            font-size: smaller;
            text-align: center!important;
            vertical-align: middle!important;
            border-width: 0!important;
            padding: 10px!important;
        }
        tbody.large-margins td {
            padding: 30px!important;
        }
        .green {
            color: green;
        }
        .red {
            color: red;
        }
        .orange {
            color: orange;
        }
        .orange-framed {
            border-style: solid;
            border-color: orange;
            border-width: 2px;
        }
        .grey-framed {
            border-style: solid;
            border-color: grey;
            border-width: 2px;
        }
        .green-framed {
            border-style: solid;
            border-color: green;
            border-width: 2px;
        }
        footer {
            position: absolute;
            bottom: 0;
            left: 1em;
            font-size: 0.5em;
            width: 100%;
        }
        footer a {
            color: #0C0239!important;
        }
        .float-right {
            position:fixed;
            top:5%;
            z-index:9999;
            font-size: 0.8em;
            right:0;
        }
        .float-left {
            float: left;
            font-size: 0.5em;
            position: fixed;
            padding: 5px;
            font-weight: bold;
        }
        .mini {
            font-size: 1px;
        }
    </style>
</head>
<body>
<div class="reveal">
    <div class="slides">
        <section>
            <a href="https://passbolt.com" target="_blank"><img style="height: 40px; margin: 40px 0" src="assets/passbolt-white.svg"></a>
            <h3>
                Bread and Butter
            </h3>
            <p class="small">Juan Pablo Ramirez - Ishan Vyas</p>
            <aside class="notes">
                Welcome to my presentation Passbolt's bread and butter, an insight on the CakePHP
                tools we value the most.
                It is a pleasure
                to be part of this event.
                I am Juan Pablo, a backend software developer at Passbolt since almost four years
                now.
                The API is co-developed with Ishan Vyas, greetings to you!
            </aside>
            <p class="small">The CakePHP Conference - July 26th 2024</p>
            <p class="small">
                <img src="assets/cakephp_grey.svg" width="100px">
            </p>
        </section>
        <section>
            <h4>Passbolt in a nutshell</h4>
            <h4 class="fragment">Dependency injection</h4>
            <h4 class="fragment">Performance</h4>
            <h4 class="fragment">Tasting tools</h4>
            <aside class="notes">
                Here is a quick overview of the presentation coming.
                I'll briefly introduce Passbolt and the API.
                I'll then explain how we integrated the dependency injection tool
                to sustain our software architecture.
                In a third part I will present the latest work we did on the API
                in terms of performance.
                Finally, I'll re-introduce the test suite light and the fixture factories
                with their latest changes, tools that are fundamental in our development
                workflow.
            </aside>
        </section>
        <section>
            <section data-background="https://www.passbolt.com/animated_devices.svg" data-background-interactive>
                <h4 style="background-color: #00000000; padding: 40px ; opacity: 0.9">
                    <p class="white-shadowed">
                        Passbolt in a nutshell
                    </p>
                </h4>
            </section>
            <section data-background-video="https://www.passbolt.com/videos/product_tour/share_with_granularity.mp4"
                 data-background-video-loop data-background-video-muted>
            </section>
            <section>
                <h2>Solutions</h2>
                <h4>Community</h4>
                <h4 class="fragment">Business</h4>
                <h4 class="fragment">Cloud</h4>
                <aside class="notes">
                    Passbolt API and in general is served with 3 different flavors.
                    The community flavor is free and features all the functionalities described above.
                    The business solution has additional features.
                    The cloud solution as similar features as the business one, but it is hosted by us.
                    This strongly shapes the architecture of our code. Some endpoints, therefore controllers
                    and commands, will have to behave differently depending on the flavor. Yet we
                    want the code to be unified: a controller should be identical through all solutions.
                </aside>
            </section>
        </section>
        <section>
            <section>
                <h2>
                    <a href="https://book.cakephp.org/4/en/development/dependency-injection.html" target="_blank">Dependency Injection</a>
                </h2>
                <p>
                    <a href="https://vierge-noire.github.io/presentations/cakefest-2023.html" target="_blank">
                        CakeFest 2023 - Luxembourg Satellite Event
                    </a>
                </p>
            </section>
            <section>
                <h4>
                    External libraries
                </h4>
                <p class="small">league/flysystem-google-cloud-storage</p>
                <p class="small">enygma/yubikey</p>
                <p class="small">duosecurity/duo_universal_php</p>
                <p class="small">firebase/php-jwt</p>
                <p class="small">directorytree/ldaprecord</p>
                <p class="small">...</p>
            </section>
        </section>
        <section>
            <section>
                <h4>Dependency Injection Example</h4>
                <h2>Image storage</h2>
                <h2>&#x26c5;</h2>
            </section>
            <section>
                <img src="assets/cakefest24/AvatarsViewController.png" height="100%">
                <aside class="notes">
                    The avatar view controller is responsible for serving the avatar
                    of a given user in a particular format.
                    The avatars are saved in DB, but also cached for performance reasons.
                    In the on-premise solutions, the avatar are cached on file in
                    a dedicated folder.
                    In the cloud solutions, the avatar are cached on a google cloud
                    storage bucket.
                </aside>
            </section>
            <section>
                <a href="https://github.com/passbolt/passbolt_api/blob/master/src/Application.php#L284" target="_blank"><pre>Application.php</pre></a>
                <p><pre data-id="code-animation"><code class="c++">
public function services(ContainerInterface $container): void
{
    $container
        ->add(FilesystemAdapter::class, LocalFilesystemAdapter::class)
        ->addArgument(TMP . 'avatars');
}
                </code></pre></p>
            </section>
            <section>
                <pre>MultiTenantPlugin.php</pre>
                <p><pre data-id="code-animation"><code class="c++">
public function services(ContainerInterface $container): void
{
    $container
        ->extend(FilesystemAdapter::class)
        ->setConcrete(MultiTenantFileStorageAdapterService::class)
        ->addArgument(PASSBOLT_ORG);
}
                </code></pre></p>
            </section>
            <section>
                <a href="https://github.com/passbolt/passbolt_api/blob/master/tests/Lib/Model/AvatarsIntegrationTestTrait.php" target="_blank"><pre>AvatarsIntegrationTestTrait.php</pre></a>
                <img src="assets/cakefest24/AvatarsIntegrationTestTrait.png" height="100%">
                <aside class="notes">
                    The FilesystemAdapter is injected prior to the test setup to ensure that
                    the tests run using the locale file storage system, and not the Google cloud
                    bucket.
                </aside>
            </section>
        </section>
        <section>
            <section>
                <h4>Dependency Injection Event</h4>
                <h3>Application.buildContainer</h3>
                <h1>&#129336;</h1>
                <aside class="notes">
                    An event is triggered when the container is created.
                    Like all events, this should be handled with care. It might
                    however help in tricky situations.
                </aside>
            </section>
            <section>
                <pre>PassboltBuildCommandsListener.php</pre>
                <img src="assets/cakefest24/PassboltBuildCommandsListener.png" height="100%">
                <aside class="notes">

                </aside>
            </section>
        </section>
        <section>
            <section>
                <h2>Performance</h2>
                <aside class="notes">
                    With an increasing number of users, certain endpoints of the API
                    had to be reshaped. Here are the tricks we used!
                </aside>
            </section>
            <section>
                <h4>Performance</h4>
                <h3>Pagination</h3>
                <p>
                    <a href="" target="_blank">bcrowe/cakephp-api-pagination</a>
                </p>
            </section>
            <section>
                <a target="_blank" href="https://github.com/passbolt/passbolt_api/blob/master/src/Datasource/Paging/NumericCountAwarePaginator.php"><pre>NumericCountAwarePaginator.php</pre></a>
                <img src="assets/cakefest24/NumericCountAwarePaginator.png" height="100%">
            </section>
        </section>
        <section>
            <section>
                <h4>Performance</h4>
                <h3>Disable hydration</h3>
                <p><pre data-id="code-animation"><code class="c++">
                    $query->disableHydration();
                </code></pre></p>
                <aside class="notes">
                    Hydration will parse all the entities returned by the DB into Entity object.
                    While this can be useful when combined with virtual fields,
                    it comes with a significant performance cost. To be avoided when querying
                    larger set of data.
                </aside>
            </section>
        </section>
        <section>
            <section>
                <h4>Performance</h4>
                <h3>Avoid result formatting</h3>
                <p><pre data-id="code-animation"><code class="c++">
$query->formatResults(function (CollectionInterface $results) {
    return $results->map(function (Resources $resource) {
        $resource['is_shared'] = count($resource['permissions']) > 1;

        return $resource;
    });
});
                </code></pre></p>
            </section>
            <section>
                <h4>Calculate fields in SQL</h4>
                <pre data-id="code-animation"><code class="c++">$countSubQuery = $this->foldersRelationsTable->selectQuery();

$personal = $query->expr()->case()
    ->when($query->expr()->eq('COUNT(*)', 1, 'integer'))
    ->then($query->newExpr('TRUE'), 'boolean')
    ->when($query->expr()->gt('COUNT(*)', 1, 'integer'))
    ->then($query->expr('FALSE'), 'boolean');

$countSubQuery->select([
    'is_personal' => $personal
])->where(['FoldersRelations.foreign_id' => $resourceId]);

return $query->selectAlso(['is_personal' => $countSubQuery]);</code></pre>
                &#129722;&#128668;
            </section>
            <section>
                <h4>unset <i>_joinData</i></h4>
                <pre>
PassboltBelongsToMany.php
                </pre>
                <pre data-id="code-animation"><code class="c++">
class PassboltBelongsToMany extends BelongsToMany
{
    public function eagerLoader(array $options): Closure
    {
        $closure = parent::eagerLoader($options);

        return function ($row) use ($closure) {
            $row = $closure($row);
            foreach ($row[$this->getAlias()] ?? [] as $i => $subRow) {
                unset($row[$this->getAlias()][$i][$this->_junctionProperty]);
            }

            return $row;
        };
    }
}
                </code></pre>
                &#128024;
            </section>
        </section>
        <section>
            <section>
                <h4>Performance</h4>
                <h3>Vanilla DateTime Type</h3>
                <pre data-id="code-animation"><code class="c++">
    TypeFactory::map('datetime', PassboltISOFormatDateTimeType::class);
                </code></pre>
                <p>&#128640;</p>
            </section>
            <section>
                <h4>Vanilla DateTime Type</h4>
                <a href="https://github.com/passbolt/passbolt_api/blob/master/src/Database/Type/ISOFormatDateTimeType.php" target="_blank"><pre>ISOFormatDateTimeType.php</pre></a>
                <pre data-id="code-animation"><code class="c++">
class PassboltISOFormatDateTimeType extends DateTimeType
{
  public function manyToPHP(array $values, array $fields, DriverInterface $driver): array
  {
    foreach ($fields as $field) {
      if (!isset($values[$field])) {
        continue;
      }

      $values[$field] = date(\DateTimeInterface::ATOM, strtotime($values[$field]));
    }

    return $values;
  }
}
                </code></pre>
            </section>
        </section>
        <section>
            <section>
                <h2>Test Fixture Factories</h2>
                <p>
                    <a target="_blank" href="https://github.com/vierge-noire/cakephp-fixture-factories">vierge-noire/cakephp-fixture-factories</a>
                </p>
            </section>
            <section>
                <h4>Test Fixture Factories</h4>
                <a href="https://github.com/passbolt/passbolt_api/blob/master/plugins/PassboltCe/PasswordExpiry/tests/TestCase/Controller/Share/PasswordExpiryShareControllerTest.php#L43" target="_blank">
                    <pre>PasswordExpiryShareControllerTest.php</pre>
                </a>
                <pre data-id="code-animation"><code class="c++">
$allUsers = [$owner, $userLosingPermission] = UserFactory::make(2)
    ->user()->persist();

[$resourceViewed, $resourceNotViewed] = ResourceFactory::make(2)
    ->withPermissionsFor([$owner, $userLosingPermission])
    ->withSecretsFor($allUsers)
    ->persist();

SecretAccessFactory::make()
    ->withUsers(UserFactory::make($userLosingPermission))
    ->withResources(ResourceFactory::make($resourceViewed))
    ->persist();

$this->logInAs($owner);
                </code></pre>
                <a href="https://github.com/passbolt/passbolt_api/blob/master/plugins/PassboltCe/Log/tests/Factory/SecretAccessFactory.php#L68" target="_blank">
                    <small><pre>SecretAccessFactory.php</pre></small>
                </a>
            </section>
            <section>
                <h4>Test Fixture Factories</h4>
                <pre>SelectQueryMocker.php</pre>
<pre data-id="code-animation" data-line-numbers><code class="c++">
$countryFactory = CountryFactory::make([['Foo'], ['Bar']]);
SelectQueryMocker::mock($this, $countryFactory);
$countries = TableRegistry::getTableLocator()->get('Countries')->find();
$this->assertSame(2, $countries->count());
$this->assertSame(0, CountryFactory::count());
                </code></pre>
            </section>
        </section>
        <section>
            <section>
                <h2>Test Suite Light</h2>
                <p>
                    <a target="_blank" href="https://github.com/vierge-noire/cakephp-test-suite-light">vierge-noire/cakephp-test-suite-light</a>
                </p>
            </section>
            <section>
                <h4>Test Suite Light</h4>
                <pre>AppIntegrationTestCase.php
</pre>
<pre data-id="code-animation" data-line-numbers><code class="c++">use Cake\TestSuite\TestCase;
use CakephpTestSuiteLight\Fixture\TruncateDirtyTables;

abstract class AppIntegrationTestCase extends TestCase
{
    use TruncateDirtyTables;

    ...
}</code></pre>
            </section>
            <section>
                <h4>Test Suite Light</h4>
                <img src="assets/cakefest24/UsersTableAfterTests.png" height="100%">
                <aside class="notes">
                    The users table is not emptied at the end of the test.
                    This enables efficient debugging.
                    It is also possible to insert dummy data in the test DB
                    in order to perform performance measurements.
                </aside>
            </section>
        </section>
        <section>
            <section>
                <a href="https://passbolt.com" target="_blank"><img style="height: 40px; margin: 40px 0" src="assets/passbolt-white.svg"></a>
                <h4>Thank you for the cake</h4>
                <p class="fragment"><a href="https://github.com/passbolt/passbolt_api" target="_blank">Passbolt API</a></p>
                <p class="fragment"><a href="https://community.passbolt.com/" target="_blank">Community Forum</a></p>
                <p class="fragment"><a target="_blank" href="https://github.com/vierge-noire/cakephp-fixture-factories">vierge-noire/cakephp-fixture-factories</a></p>
                <p class="fragment"><a target="_blank" href="https://vierge-noire.github.io/presentations/cakefest-2024.html">
                    https://vierge-noire.github.io/presentations/cakefest-2024.html
                </a></p>
                <p class="small">
                    <img src="assets/cakephp_grey.svg" width="100px">
                </p>
            </section>
            <section>
                <a href="https://vierge-noire.github.io/presentations/cakefest-2024.html" target="_blank">
                    <small>https://vierge-noire.github.io/presentations/cakefest-2024.html</small>
                    <img src="assets/cakefest24/QR_code_presentation.png" height="500px">
                </a>
            </section>
        </section>
    </div>
</div>
<script src="dist/reveal.js"></script>
<script src="plugin/notes/notes.js"></script>
<script src="plugin/markdown/markdown.js"></script>
<script src="plugin/highlight/highlight.js"></script>
<script src="plugin/chart/Chart.min.js"></script>
<script src="plugin/chart/plugin.js"></script>
<script>

    $(function(){
        $(".baked-with-cakephp").html('<div class="float-right">\n' +
            '    <a href="https://book.cakephp.org/authentication/2/en/authenticators.html#jwt" target="_blank">\n' +
            '        <img src="http://www.cakephp.org/img/flags/Baked-with-CakePHP.png" width="150px;">\n' +
            '    </a>\n' +
            '</div>');
    });

    // More info about initialization & config:
    // - https://revealjs.com/initialization/
    // - https://revealjs.com/config/
    Reveal.initialize({
        hash: true,
        slideNumber: 'c/t',

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealChart ],


        chart: {
            defaults: {
                global: {
                    title: { fontColor: "#FFF" },
                    legend: {
                        labels: { fontColor: "#FFF" },
                    },
                },
                scale: {
                    scaleLabel: { fontColor: "#FFF" },
                    gridLines: { color: "#FFF", zeroLineColor: "#FFF" },
                    ticks: { fontColor: "#FFF" },
                }
            },
            line: { borderColor: [ "rgba(20,220,220,.8)" , "rgba(220,120,120,.8)", "rgba(20,120,220,.8)" ], "borderDash": [ [5,10], [0,0] ]},
        },
    });
</script>
</body>
</html>
